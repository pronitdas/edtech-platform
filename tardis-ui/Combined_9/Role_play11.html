<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customizable Roleplay Scenario</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: url('https://via.placeholder.com/800x600.png?text=Default+Background+Scene') no-repeat center center fixed;
            background-size: cover;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        #game-container {
            width: 90%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.3);
            border-radius: 20px;
        }

        .speech-bubble {
            background: #f8d568;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            position: relative;
            color: #333;
        }

        .speech-bubble:after {
            content: "";
            position: absolute;
            bottom: -15px;
            left: 20px;
            width: 0;
            height: 0;
            border: 15px solid transparent;
            border-top-color: #f8d568;
        }

        #mentor-image,
        #skeptical-image,
        #impactful-image {
            width: 150px;
            height: 150px;
            background: url('https://via.placeholder.com/150.png?text=Character') no-repeat center center;
            background-size: cover;
            border-radius: 50%;
            margin-bottom: 15px;
        }

        #user-response {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border-radius: 15px;
            border: 1px solid #ccc;
        }

        button {
            margin-top: 10px;
            padding: 10px;
            border: none;
            background-color: #ff9800;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background-color: #e68900;
        }

        .character-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <h1>Welcome to the Customizable Roleplay Scenario</h1>
        <div id="input-section">
            <label for="topic">Enter the Topic:</label>
            <input type="text" id="topic" placeholder="e.g., Integrated Marketing Communication">
            <br>
            <label for="scenarios">Enter Scenario Options (comma separated):</label>
            <input type="text" id="scenarios" placeholder="e.g., Scenario 1, Scenario 2, Scenario 3">
            <br>
            <label for="concepts">Enter Concepts to be Taught (comma separated):</label>
            <input type="text" id="concepts" placeholder="e.g., Brand Positioning, Target Audience Identification">
            <br>
            <button onclick="startGame()">Start Roleplay</button>
        </div>
        <div id="mentor-output" style="display: none;">
            <div class="character-container">
                <div id="mentor-image"></div>
                <div id="mentor-bubble" class="speech-bubble">
                    Hello, I'm AI-Mentor! Let's start your journey. Please share your experience level and any
                    background information with me. This helps me tailor the roleplay scenario for you.
                </div>
            </div>
        </div>
        <div id="skeptical-output" style="display: none;">
            <div class="character-container">
                <div id="skeptical-image"></div>
                <div id="skeptical-bubble" class="speech-bubble">
                    I'm Skeptical Sam. Why should we even consider this approach?
                </div>
            </div>
        </div>
        <div id="impactful-output" style="display: none;">
            <div class="character-container">
                <div id="impactful-image"></div>
                <div id="impactful-bubble" class="speech-bubble">
                    Hi, I'm Impactful Ivy. I'm looking for something that makes a real difference. Show me what you've
                    got!
                </div>
            </div>
        </div>
        <div id="user-input" style="display: none;">
            <textarea id="user-response" placeholder="Type your response here..."></textarea>
            <button onclick="nextStep()">Submit</button>
        </div>
    </div>

    <script>
        const openAiApiKey = "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";
        let step = 1;
        let userExperience = "";
        let scenarios = [];
        let concepts = [];
        const imageCache = {};

        function startGame() {
            const topic = document.getElementById('topic').value;
            scenarios = document.getElementById('scenarios').value.split(',').map(s => s.trim());
            concepts = document.getElementById('concepts').value.split(',').map(c => c.trim());

            if (topic && scenarios.length && concepts.length) {
                document.getElementById('input-section').style.display = 'none';
                document.getElementById('mentor-output').style.display = 'block';
                document.getElementById('user-input').style.display = 'block';
            } else {
                alert('Please fill out all fields to start the game.');
            }
        }

        async function getOpenAIResponse(prompt, retryCount = 3) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openAiApiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.7,
                        max_tokens: 150
                    })
                });

                if (!response.ok) {
                    console.error(`OpenAI API returned an error: ${response.status} ${response.statusText}`);
                    if (retryCount > 0) {
                        console.log("Retrying... Attempts left: " + retryCount);
                        return await getOpenAIResponse(prompt, retryCount - 1);
                    }
                    return "There was an issue fetching the response from OpenAI. Please try again later.";
                }

                const data = await response.json();
                if (data?.choices?.length > 0 && data.choices[0].message?.content) {
                    return data.choices[0].message.content;
                } else {
                    console.warn("Unexpected response structure:", data);
                    return "I couldn't generate a response. Please try again.";
                }
            } catch (error) {
                console.error("Error fetching data from OpenAI: ", error);
                if (retryCount > 0) {
                    console.log("Retrying... Attempts left: " + retryCount);
                    return await getOpenAIResponse(prompt, retryCount - 1);
                }
                return "I'm having trouble connecting to the OpenAI server. Please try again later.";
            }
        }

        async function getDallEImage(prompt) {
            if (imageCache[prompt]) {
                return imageCache[prompt];
            }
            try {
                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openAiApiKey}`
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        n: 1,
                        size: "256x256"
                    })
                });
                const data = await response.json();
                if (data.data && data.data.length > 0) {
                    const imageUrl = data.data[0].url;
                    imageCache[prompt] = imageUrl;
                    return imageUrl;
                } else {
                    return "https://via.placeholder.com/256.png?text=No+Image";
                }
            } catch (error) {
                console.error("Error fetching image from DALL-E: ", error);
                return "https://via.placeholder.com/256.png?text=Error";
            }
        }

        async function nextStep() {
            const userResponse = document.getElementById('user-response').value;
            if (userResponse.trim() === "") {
                alert("Please provide your response.");
                return;
            }

            switch (step) {
                case 1:
                    userExperience = userResponse;
                    let mentorText1 = "Thank you for sharing! Based on your input, here are some scenarios for you to choose from:";
                    scenarios.forEach((scenario, index) => {
                        mentorText1 += `\n${index + 1}. ${scenario}`;
                    });
                    updateMentorOutput(mentorText1);
                    break;
                case 2:
                    let scenarioChoice = parseInt(userResponse);
                    if (isNaN(scenarioChoice) || scenarioChoice < 1 || scenarioChoice > scenarios.length) {
                        alert(`Please choose a valid option (1 to ${scenarios.length}).`);
                        return;
                    }

                    const selectedScenario = scenarios[scenarioChoice - 1];
                    const backgroundImage = await getDallEImage(selectedScenario);
                    document.body.style.backgroundImage = `url(${backgroundImage})`;

                    let mentorImageUrl = await getDallEImage(`Character for mentor in scenario: ${selectedScenario}`);
                    document.getElementById('mentor-image').style.backgroundImage = `url(${mentorImageUrl})`;

                    let skepticalImageUrl = await getDallEImage(`Male character, Skeptical Sam, for scenario: ${selectedScenario}`);
                    document.getElementById('skeptical-image').style.backgroundImage = `url(${skepticalImageUrl})`;

                    let impactfulImageUrl = await getDallEImage(`Female character, Impactful Ivy, for scenario: ${selectedScenario}`);
                    document.getElementById('impactful-image').style.backgroundImage = `url(${impactfulImageUrl})`;

                    updateMentorOutput(selectedScenario + "\n\nBEGIN ROLE PLAY!");
                    document.getElementById('skeptical-output').style.display = 'flex';
                    document.getElementById('impactful-output').style.display = 'flex';
                    break;
                case 3:
                    let skepticalResponse = await getOpenAIResponse("Skeptical point of view: " + userExperience + "\n\n" + userResponse);
                    document.getElementById('skeptical-bubble').innerText = skepticalResponse;

                    let impactfulResponse = await getOpenAIResponse("Impactful campaign point of view: " + userExperience + "\n\n" + userResponse);
                    document.getElementById('impactful-bubble').innerText = impactfulResponse;
                    break;
                case 4:
                    let feedbackResponse = "GENERAL FEEDBACK: You did well on addressing the main objectives, but there's always room for improvement.\n\nADVICE MOVING FORWARD: Focus more on exploring your counterpart's motivations to find a common ground for mutual benefit.";
                    let score = Math.floor(Math.random() * 41) + 60; // Score between 60-100
                    feedbackResponse += `\n\nYour Score: ${score}/100`;
                    updateMentorOutput(feedbackResponse);
                    break;
                case 5:
                    let summary = "SUMMARY OF STRENGTHS AND WEAKNESSES:\n\nStrengths: You successfully addressed the core issues.\n\nWeaknesses: Try to involve more emotional appeal in your communication to make a stronger impact.";
                    updateMentorOutput(summary);
                    break;
                default:
                    updateMentorOutput("If you have more questions or want to try another scenario, feel free to ask!");
                    break;
            }
            step++;
            document.getElementById('user-response').value = "";
            document.getElementById('user-response').focus();
        }

        function updateMentorOutput(text) {
            document.getElementById('mentor-bubble').innerText = text;
        }
    </script>
</body>

</html>